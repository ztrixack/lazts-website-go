---
Title: Unit Testing บน C/C++ ใน Microcontrollers
Slug: 20240514-unit-testing-c-cpp-microcontrollers
Excerpt: มารู้จักกับ Unit Testing สำหรับภาษา C/C++ บนไมโครคอนโทรลเลอร์ ที่ไม่เพียงแค่ช่วยปรับปรุงคุณภาพของโค้ด แต่ยังทำให้การพัฒนาซอฟต์แวร์ง่ายขึ้นและสนุกมากขึ้นด้วย Framework ต่างๆ ที่มีให้เลือกใช้หลากหลาย
FeaturedImage: https://picsum.photos/1024/768?random=12
PublishedAt: 2024-05-14
Published: true
Tags:
  - embedded
  - test
  - C/C++
---

การเขียนโค้ดบนไมโครคอนโทรลเลอร์จะมีความท้าทายที่แตกต่างจากการเขียนซอฟต์แวร์ทั่วๆ ไป เพราะโค้ดจะถูกฝังลงไปในอุปกรณ์ที่เรามองไม่เห็นและเข้าถึงมันได้ยาก ถ้าเกิดปัญหาขึ้นมา เราอาจต้องเสียเวลามากในการค้นหาสาเหตุ ที่ไม่รู้ว่าเป็นเพราะโค้ดที่เราเขียนหรืออุปกรณ์มันเพี้ยนไป และยิ่งถ้าเป็นช่วงเวลาสำคัญอย่างการนำเสนองานต่อหน้าลูกค้าละก็ ความผิดพลาดเล็กๆ น้อยๆ ก็อาจทำให้เราได้พบลูกค้าคนนั้นเป็นครั้งสุดท้าย!

นี่แหละคือเหตุผลที่เราต้องการ Unit Testing มาช่วย! Unit Testing เป็นวิธีที่ทำให้เรามั่นใจได้ว่าแต่ละส่วนของโค้ดจะทำงานได้ตามที่เราต้องการและคาดหวัง นอกจากนี้ยังช่วยให้โค้ดของเรามีคุณภาพดีขึ้นและง่ายต่อการดูแลรักษา ช่วยให้เราค้นหาข้อผิดพลาดได้เร็ว แก้ไขได้ทันที และลดความเสี่ยงที่โค้ดจะพังในช่วงเวลาสำคัญ (ถึง hardware จะพังจริงๆ แต่อย่างน้อยเราก็มั่นใจได้ว่า firmware ทำงานได้ถูกต้อง)

การนำ Unit Testing มาใช้ในการพัฒนาไมโครคอนโทรลเลอร์จึงไม่ใช่แค่การเพิ่มขั้นตอนและเวลาในการพัฒนา แต่เป็นการลงทุนเพื่อให้แน่ใจว่าระบบของเราจะทำงานได้อย่างมั่นคงและมีประสิทธิภาพ แม้ในสถานการณ์ที่ท้าทายที่สุด (ใครละ จะอยากเจอปัญหาตอนที่มีหัวหน้าคอยยืนดูอยู่ข้างหลัง!)

## ความสำคัญของ Unit Testing

ถ้าเรามีการเขียนโค้ดที่ดี แก้โค้ดง่าย อุปกรณ์พร้อม และมีความสามารถในการหา bug หรือเพิ่ม feature ได้อย่างรวดเร็ว หากเวลาผ่านไปแล้วเป็นเดือนๆ Unit Testing ก็คงจะไม่จำเป็นมากนัก แต่ในความเป็นจริง การหา bug มักเป็นเรื่องยากและใช้เวลานาน หรือการเพิ่ม feature ใหม่ๆ ก็มักจะกระทบกับส่วนอื่นๆ จนต้องทดสอบกันทุกครั้ง ทำให้ต้องเสียเวลาในการทำงานซ้ำๆ บ่อยๆ ซึ่งคงไม่มีใครอยากเสียเวลาแก้โค้ดลากยาวจนดึกดื่น หรือตื่นมาแก้โค้ดตอนตีสาม

อย่างที่บอกไป Unit Testing มีความสำคัญในกระบวนการพัฒนาไมโครคอนโทรลเลอร์ ช่วยให้เราค้นพบข้อผิดพลาดได้เร็วขึ้น ลดค่าใช้จ่ายและความพยายามในการ refactor หรือ optimize โค้ด นอกจากนี้ Unit Testing ยังส่งเสริมการเขียนโค้ดและการออกแบบที่ดีขึ้น ทำให้โค้ดของเราดูดีจนเพื่อนๆ ต้องอิจฉา และยังช่วยให้มั่นใจว่า feature ใหม่หรือการแก้ไขโค้ดจะไม่ทำให้โค้ดเดิมพัง ป้องกันการเกิดบั๊กซ้ำหรือปัญหาที่ไม่คาดคิด ซึ่งเราเองก็คงไม่อยากให้ปัญหาเก่าๆ กลับมากวนใจอีกใช่ไหม?

นอกจากนี้ Unit Testing ยังช่วยให้ requirement ชัดเจนขึ้น รวมถึงฟังก์ชันและพฤติกรรมของโค้ดที่เราคาดหวัง ทำให้เหมือนมีคู่มือแนะนำว่าโค้ดทำงานอย่างไร ตัวอย่างข้อมูลเป็นอย่างไร หรือถ้าโค้ดจะพัง ข้อมูลต้องเป็นแบบไหน ซึ่งแตกต่างจากเอกสารประกอบหรือ comment ที่เรามักจะไม่ค่อยเขียนกัน ซึ่งยากต่อการทำความเข้าใจและแกะโค้ด

สุดท้าย Unit Testing ยังช่วยให้เรามั่นใจว่าโค้ดทำงานตามที่ตั้งใจไว้ แม้จะมีการเปลี่ยนแปลง จะเปลี่ยนโค้ดกี่ครั้งก็ไม่มีปัญหา

## ความท้าทายในการทำ Unit Testing บนไมโครคอนโทรลเลอร์

การเขียน Unit Testing สำหรับซอฟต์แวร์ปกติมักเป็นเรื่องง่ายกว่า (แต่คนรอบๆ ตัวก็ไม่ค่อยเห็นทำกัน) เพราะโค้ดสามารถรันบนคอมพิวเตอร์ทั่วไปและใช้เครื่องมือที่มีอยู่มากมาย เช่น JUnit สำหรับ Java หรือ PyTest สำหรับ Python Unit Testing ในซอฟต์แวร์ปกติมักจะไม่ต้องกังวลเรื่องฮาร์ดแวร์ ทำให้สามารถโฟกัสที่การทดสอบฟังก์ชันและการทำงานของโค้ดได้เต็มที่

แต่สำหรับไมโครคอนโทรลเลอร์ การเขียนเฟิร์มแวร์มักเน้นไปที่การควบคุมการทำงานของฮาร์ดแวร์หรืออุปกรณ์ต่างๆ เช่น การอ่าน/เขียนรีจิสเตอร์ การตอบสนองต่อเหตุการณ์หรืออินเทอร์รัปต์จากภายนอก เราต้องทดสอบและดีบักพร้อมกับอุปกรณ์ไปด้วยอยู่แล้ว การเขียน Unit Testing มาทดสอบอีกครั้งหลังจากทำ end-to-end testing แล้ว จึงดูเหมือนไม่คุ้มค่าเหนื่อย

### End-to-End Testing คืออะไร?

End-to-End Testing (E2E) คือกระบวนการทดสอบซอฟต์แวร์ที่ตรวจสอบการทำงานของระบบทั้งหมดตั้งแต่ต้นจนจบ เพื่อให้แน่ใจว่าทุกส่วนของระบบทำงานร่วมกันอย่างถูกต้อง ในกรณีของไมโครคอนโทรลเลอร์ End-to-End Testing หมายถึงการทดสอบเฟิร์มแวร์พร้อมกับฮาร์ดแวร์ทั้งหมด เช่น การทดสอบว่าเมื่อกดปุ่มบนอุปกรณ์แล้ว ไฟ LED จะติดตามที่เขียนไว้ หรือการทดสอบว่าเซนเซอร์สามารถอ่านค่าได้ถูกต้อง

End-to-End Testing บนไมโครคอนโทรลเลอร์จึงมีความซับซ้อนในอีกรูปแบบหนึ่งซึ่งต่างจากกรณีอื่นๆ เพราะต้องตรวจสอบทั้งซอฟต์แวร์และฮาร์ดแวร์ร่วมกัน ทำให้เกิดความท้าทายหลายอย่าง เช่น การจัดการกับ interrupt การตรวจสอบการทำงานของรีจิสเตอร์ และการประสานงานระหว่างโมดูลต่างๆ ในระบบ นอกจากนี้ยังต้องใช้เครื่องมือพิเศษ เช่น logic analyzer หรือ oscilloscope เพื่อวิเคราะห์สัญญาณดิจิตอลและอนาล็อก ซึ่งทำให้การทดสอบมีความยุ่งยากและต้องใช้เวลาและความพยายามมากขึ้น

อย่างไรก็ตาม หากมองในอีกมุมหนึ่ง โค้ดบนไมโครคอนโทรลเลอร์ก็ไม่ได้ต่างจากระบบอื่นๆ ถ้าเราแยกส่วนของฮาร์ดแวร์ เช่น การเขียนรีจิสเตอร์ อินเทอร์รัปต์ ฯลฯ ออกมาให้อยู่ในรูปของโมดูลหรือบริการ การออกแบบโครงสร้างของเฟิร์มแวร์ให้สามารถแยกชั้นฮาร์ดแวร์และแอปพลิเคชันได้ชัดเจน ก็จะทำให้การเขียน Unit Test เป็นเรื่องง่ายขึ้น ส่วนของฮาร์ดแวร์ก็ใช้ logic analyzer, oscilloscope, หรืออุปกรณ์อื่นๆ ส่วนที่เหลือก็จะเป็นเพียงโค้ด C/C++ เพียวๆ ที่สามารถทดสอบบนระบบได้

ท้ายที่สุด แม้จะมีความท้าทาย แต่ Unit Testing ก็เป็นสิ่งสำคัญที่ช่วยให้เฟิร์มแวร์มีคุณภาพและความน่าเชื่อถือ การลงทุนเวลาในการเขียน Unit Testing จะช่วยลดปัญหาในระยะยาว ทำให้การพัฒนาซอฟต์แวร์มีประสิทธิภาพมากขึ้นและพร้อมรับมือกับทุกสถานการณ์ และทำให้เราเรียนรู้และพัฒนาทักษะการเขียนโค้ดให้ดีขึ้น

## เปรียบเทียบ Unit Testing Framework

การเลือก Framework ที่เหมาะสมสำหรับ Unit Testing เป็นเรื่องสำคัญมาก

| Framework    | Language | Lightweight | Mocking Framework   | Embedded | Comments                   |
| ------------ | -------- | ----------- | ------------------- | -------- | -------------------------- |
| [CUnit]      | C        | Yes         | No                  | Limited  | good for basic testing     |
| [CMock]      | C        | Yes         | Yes                 | Yes      | enhances isolation         |
| [Unity]      | C        | Yes         | Yes (CMock)         | Yes      | minimal overhead           |
| [Ceedling]   | C        | Yes         | Yes (Unity & CMock) | Yes      | streamlines workflow       |
| [GoogleTest] | C++      | No          | Yes (GMock)         | Limited  | powerful, well-document    |
| [CppUTest]   | C/C++    | Yes         | Yes (CppUMock)      | Yes      | flexible, active community |
| [Check]      | C        | Yes         | No                  | Limited  | easy to use, good for CI   |

### CUnit
CUnit เป็น Unit Testing Framework สำหรับภาษา C ที่ออกแบบมาเพื่อความเรียบง่ายและใช้งานง่าย มันช่วยให้นักพัฒนาสามารถเขียน Unit Test Cases และจัดการกับชุดทดสอบได้อย่างง่ายดาย มีฟังก์ชันพื้นฐานสำหรับการทำ assertions เช่นการตรวจสอบความเท่ากันของค่า การตรวจสอบค่าจริง/เท็จ และการตรวจสอบความถูกต้องของพอยน์เตอร์ ข้อเสียของ CUnit คือมันไม่มีความสามารถในการทำ Mocking ทำให้มีข้อจำกัดในการทดสอบโค้ดที่มีการพึ่งพา dependencies ภายนอก

### CMock
CMock เป็น Framework การทำ Mocking สำหรับภาษา C ที่ใช้ร่วมกับ Unity ซึ่งเป็น Unit Testing Framework  CMock ช่วยให้นักพัฒนาสามารถสร้าง mocks และ stubs สำหรับฟังก์ชันที่มีการพึ่งพา dependencies ภายนอกได้อย่างง่ายดาย โดย CMock จะสร้างฟังก์ชันจำลองขึ้นมาแทนที่ฟังก์ชันจริงในโค้ด ทำให้สามารถทดสอบฟังก์ชันที่เหลือได้ในสภาพแวดล้อมที่แยกออกมา ข้อดีของ CMock คือมันทำให้การทดสอบโค้ดที่ซับซ้อนและการพึ่งพาภายนอกเป็นเรื่องง่ายขึ้น

### Unity
Unity เป็น Unit Testing Framework สำหรับภาษา C ที่ถูกออกแบบมาให้มีน้ำหนักเบาและใช้งานง่าย มันมีฟังก์ชันการยืนยันที่หลากหลาย เช่นการตรวจสอบค่าจริง/เท็จ การตรวจสอบความเท่ากันของค่า และการตรวจสอบข้อยกเว้น Unity ยังรองรับการทำงานร่วมกับ CMock เพื่อเพิ่มความสามารถในการทำ Mocking ทำให้สามารถทดสอบโค้ดที่มีการพึ่งพา dependencies ภายนอกได้ง่ายขึ้น Unity ถูกใช้อย่างแพร่หลายในโครงการ embedded และไมโครคอนโทรลเลอร์เนื่องจากมีขนาดเล็กและมีประสิทธิภาพสูง

### Ceedling
Ceedling เป็น Unit Testing Framework ที่ครอบคลุมสำหรับภาษา C มันรวมเอา Unity และ CMock เข้าด้วยกัน และเพิ่มเครื่องมือในการจัดการโครงการและ workflow Ceedling ช่วยในการสร้างโครงการ การจัดการการทดสอบ การสร้างรายงานผลการทดสอบ และการทำงานร่วมกับระบบ CI ทำให้กระบวนการทดสอบหน่วยเป็นไปอย่างราบรื่นและมีประสิทธิภาพมากขึ้น Ceedling ยังมี plugin ที่สามารถเพิ่มความสามารถเพิ่มเติมได้ตามต้องการ

### GoogleTest
GoogleTest เป็น Unit Testing Framework ที่ทรงพลังสำหรับภาษา C++ มันถูกพัฒนาโดย Google และมีเอกสารประกอบที่ครอบคลุม GoogleTest รองรับการทำ Mocking ผ่าน GMock ซึ่งช่วยให้นักพัฒนาสามารถสร้าง mocks และ stubs สำหรับ dependencies ได้อย่างง่ายดาย GoogleTest มีฟังก์ชันการยืนยันที่หลากหลายและสามารถสร้างการทดสอบที่ซับซ้อนได้ ข้อเสียคือ GoogleTest ไม่ใช่ Framework ที่มีน้ำหนักเบา ทำให้ไม่เหมาะสำหรับการใช้งานในระบบที่มีข้อจำกัดด้านทรัพยากร

### CppUTest
CppUTest เป็น Unit Testing Framework ที่รองรับทั้งภาษา C และ C++ มีน้ำหนักเบาและรองรับการทำ Mocking ผ่าน CppUMock CppUTest ถูกออกแบบมาเพื่อการทดสอบหน่วยในระบบฝังตัว (embedded systems) และมีชุมชนที่ใช้งานอย่างต่อเนื่อง มันมีฟังก์ชันการยืนยันที่หลากหลายและสามารถจัดการกับการทดสอบที่ซับซ้อนได้อย่างมีประสิทธิภาพ ข้อดีของ CppUTest คือมันมีความยืดหยุ่นสูงและสามารถปรับแต่งได้ตามความต้องการของโครงการ

### Check
Check เป็น Unit Testing Framework สำหรับภาษา C ที่มีน้ำหนักเบาและใช้งานง่าย มันถูกออกแบบมาให้ทำงานร่วมกับระบบ Continuous Integration (CI) ได้ดี Check มีฟังก์ชันการยืนยันพื้นฐานและการจัดการกับชุดทดสอบที่ง่ายดาย ข้อเสียของ Check คือมันไม่มีความสามารถในการทำ Mocking ทำให้มีข้อจำกัดในการทดสอบโค้ดที่มีการพึ่งพา dependencies ภายนอก แม้จะมีข้อจำกัด แต่ Check ก็ยังเป็นเครื่องมือที่ดีสำหรับการทดสอบพื้นฐานในโครงการที่ไม่ซับซ้อน

## สรุป

การทำ Unit Testing ในการพัฒนาไมโครคอนโทรลเลอร์เป็นสิ่งสำคัญในการสร้างซอฟต์แวร์ที่เชื่อถือได้และสามารถบำรุงรักษาได้ โดยการใช้ Framework อย่าง Unity, CMock, และ Ceedling นักพัฒนาสามารถนำการทดสอบหน่วยมาใช้และปฏิบัติตามแนวทางปฏิบัติที่ดีที่สุด เช่น TDD และการรวมเข้ากับ CI แนวทางเหล่านี้ช่วยให้มั่นใจว่าซอฟต์แวร์ฝังตัวมีความแข็งแกร่ง มีบั๊กน้อยลง และง่ายต่อการบำรุงรักษา

โดยการปฏิบัติตามแนวทางเหล่านี้และใช้เครื่องมือที่เหมาะสม เราก็สามารถปรับปรุงคุณภาพของโครงการไมโครคอนโทรลเลอร์ของคุณและส่งมอบระบบฝังตัวที่เชื่อถือได้

## Reference
[How To Implement C Programming Unit Testing Successfully](https://marketsplash.com/c-programming-unit-testing/)
[What is the Best Unit Testing Framework in C for You?](https://moderncprogramming.com/what-is-the-best-unit-testing-framework-in-c-for-you/)
[Modern unit testing in C with TDD and Ceedling](https://www.embedded.com/modern-unit-testing-in-c-with-tdd-and-ceedling/)
[When to Mock Unit Testing C/C++ Code](https://www.parasoft.com/blog/unit-testing-c-code-when-to-mock/)
[Test-driven development and unit testing with examples in C++](https://alexott.net/en/cpp/CppTestingIntro.html)
[List of unit testing frameworks](https://en.wikipedia.org/wiki/List_of_unit_testing_frameworks#C++)

[CUnit]: http://cunit.sourceforge.net/
[Unity]: http://www.throwtheswitch.org/unity
[CMock]: https://github.com/ThrowTheSwitch/CMock
[Ceedling]: https://github.com/ThrowTheSwitch/Ceedling
[GoogleTest]: https://github.com/google/googletest
[CppUTest]: http://cpputest.github.io/
[Check]: https://libcheck.github.io/check/
